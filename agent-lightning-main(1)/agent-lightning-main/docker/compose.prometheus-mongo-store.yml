services:

  mongo:
    extends:
      file: compose.mongo.yml
      service: mongo

    hostname: mongo
    volumes:
      - ./data/mongo-container:/data/db
      - ../scripts/mongodb_init_rs_profiling.js:/docker-entrypoint-initdb.d/init-rs.js:ro

    # This forces "mongo" to resolve to localhost ONLY inside this container.
    # This allows rs.initiate to succeed using the hostname "mongo".
    extra_hosts:
      - "mongo:127.0.0.1"

  app:
    extends:
      file: compose.store.yml
      service: app

    depends_on:
      - mongo

    command: agl store --host 0.0.0.0 --port 4747 --prometheus --backend mongo --mongo-uri mongodb://mongo:27017/?replicaSet=rs0 --n-workers 4

  mongodb-exporter:
    image: percona/mongodb_exporter:0.47.1
    command:
      - '--mongodb.uri=mongodb://mongo:27017/'
      - '--collect-all'
      - '--mongodb.collstats-colls=agentlightning.rollouts,agentlightning.attempts,agentlightning.spans,agentlightning.resources,agentlightning.workers,agentlightning.rollout_queue,agentlightning.span_sequence_ids'
    depends_on:
      - mongo
    ports:
      - "9216:9216"

  node-exporter:
    image: prom/node-exporter:latest
    # In CI you might not have full /proc, but this is OK for container-level stats
    pid: "host"
    command:
      - '--path.rootfs=/host'
    volumes:
      - '/:/host:ro,rslave'

  prometheus:
    image: prom/prometheus:latest
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=1h'
    volumes:
      - ./prometheus.mongo-store.yml:/etc/prometheus/prometheus.yml:ro
      - ./data/prometheus:/prometheus
    depends_on:
      - app
      - mongodb-exporter
      - node-exporter
    ports:
      - "9090:9090"
